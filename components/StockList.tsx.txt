
import React, { useState } from 'react';
import { StockData, AnalysisType, BacktestStrategy } from '../types';
import { TrendingUp, Clock, ShieldAlert, Activity, History, BarChart2, Scale, Bell, BellRing, CheckCircle2 } from 'lucide-react';

interface StockListProps {
  stocks: StockData[];
  type: AnalysisType;
  backtestStrategy?: BacktestStrategy;
}

export const StockList: React.FC<StockListProps> = ({ stocks, type, backtestStrategy }) => {
  const [activeAlerts, setActiveAlerts] = useState<string[]>([]);
  const [toastMessage, setToastMessage] = useState<string | null>(null);

  if (!stocks || stocks.length === 0) return null;

  const isBacktest = type === AnalysisType.BACKTEST;
  const isTechnical = type === AnalysisType.TECHNICAL;
  const isFundamental = type === AnalysisType.FUNDAMENTAL;

  const handleSetAlert = (symbol: string, condition: string) => {
    setActiveAlerts(prev => [...prev, symbol]);
    setToastMessage(`Alert set for ${symbol}: ${condition}`);
    
    // Simulate persistent storage
    localStorage.setItem(`alert_${symbol}`, condition);

    setTimeout(() => setToastMessage(null), 3000);
  };

  const getTitle = () => {
    if (isBacktest) {
       return backtestStrategy === BacktestStrategy.FUNDAMENTAL 
         ? 'Historical Fundamental Performance' 
         : 'Historical Technical Setup Performance';
    }
    if (isTechnical) return 'Audited Technical Setups';
    return 'Audited Long-Term Picks';
  };

  const getBorderColor = () => {
    if (isBacktest) {
       return backtestStrategy === BacktestStrategy.FUNDAMENTAL ? 'border-purple-500' : 'border-pink-500';
    }
    if (isTechnical) return 'border-orange-500';
    return 'border-blue-500';
  };

  return (
    <div className="space-y-6 relative">
      
      {/* Toast Notification */}
      {toastMessage && (
        <div className="fixed top-24 right-4 z-50 bg-emerald-600 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-2 animate-fade-in border border-emerald-500">
          <CheckCircle2 className="w-5 h-5" />
          <span className="font-medium text-sm">{toastMessage}</span>
        </div>
      )}

      <h2 className={`text-2xl font-bold text-white mb-4 border-l-4 pl-4 ${getBorderColor()}`}>
        {getTitle()}
      </h2>

      <div className="overflow-x-auto bg-slate-900 border border-slate-800 rounded-xl shadow-xl">
        <table className="w-full text-left border-collapse">
          <thead>
            <tr className="bg-slate-800/50 text-slate-400 text-sm uppercase tracking-wider">
              <th className="p-4 font-semibold">Stock</th>
              <th className="p-4 font-semibold">Sector</th>
              
              {/* Price Columns */}
              <th className="p-4 font-semibold text-right">
                {isBacktest ? 'Entry Price' : 'Price'}
              </th>
              <th className="p-4 font-semibold text-right">
                {isBacktest ? 'Current Price' : 'Target'}
              </th>
              
              {/* Return/Upside */}
              <th className="p-4 font-semibold text-right">
                {isBacktest ? 'Realized Return' : 'Upside'}
              </th>

              {/* Alerts Column */}
              {!isBacktest && <th className="p-4 font-semibold text-center w-32">Set Alert</th>}

              {/* Technical Specific Columns */}
              {isTechnical && <th className="p-4 font-semibold text-right text-red-400">Stop Loss</th>}
              {isTechnical && <th className="p-4 font-semibold text-center">RSI (14)</th>}
              {isTechnical && <th className="p-4 font-semibold text-center">Volume Action</th>}

              {/* Fundamental Specific Columns */}
              {isFundamental && <th className="p-4 font-semibold text-center">PEG Ratio</th>}
              {isFundamental && <th className="p-4 font-semibold text-center">Debt/Eq</th>}
              
              <th className="p-4 font-semibold">Time Frame</th>
              <th className="p-4 font-semibold w-1/3">Auditor's Note</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-800 text-slate-300 text-sm">
            {stocks.map((stock, index) => {
              // Calculate displayed percentage
              let percentageDisplay = '0%';
              let percentageValue = 0;

              if (isBacktest) {
                percentageValue = stock.returnPercentage || 0;
                percentageDisplay = `${percentageValue.toFixed(1)}%`;
              } else {
                percentageValue = ((stock.targetPrice - stock.currentPrice) / stock.currentPrice * 100);
                percentageDisplay = `${percentageValue.toFixed(1)}%`;
              }
              
              const isPositive = percentageValue >= 0;
              const hasAlert = activeAlerts.includes(stock.symbol);

              return (
                <tr key={index} className="hover:bg-slate-800/30 transition-colors group">
                  <td className="p-4">
                    <div className="font-bold text-white">{stock.symbol}</div>
                    <div className="text-xs text-slate-500">{stock.name}</div>
                  </td>
                  <td className="p-4">
                    <span className="px-2 py-1 rounded-full bg-slate-800 text-slate-400 text-xs border border-slate-700">
                      {stock.sector}
                    </span>
                  </td>

                  <td className="p-4 text-right font-mono text-slate-200">
                    {isBacktest 
                      ? `₹${stock.entryPrice?.toLocaleString()}` 
                      : `₹${stock.currentPrice.toLocaleString()}`
                    }
                  </td>

                  <td className={`p-4 text-right font-mono font-bold ${isBacktest ? 'text-slate-200' : 'text-emerald-400'}`}>
                    {isBacktest 
                      ? `₹${stock.currentPrice.toLocaleString()}` 
                      : `₹${stock.targetPrice.toLocaleString()}`
                    }
                  </td>

                  <td className="p-4 text-right">
                    <div className={`flex items-center justify-end gap-1 font-medium ${isPositive ? 'text-emerald-500' : 'text-red-500'}`}>
                      {isPositive ? <TrendingUp className="w-3 h-3" /> : <Activity className="w-3 h-3 rotate-180" />}
                      {percentageDisplay}
                    </div>
                  </td>

                  {!isBacktest && (
                    <td className="p-4 text-center">
                      <button 
                        onClick={() => handleSetAlert(stock.symbol, isTechnical ? (stock.technicalTrigger || "Technical Trigger") : `Buy under ₹${stock.buyAlert}`)}
                        className={`p-2 rounded-lg transition-all ${hasAlert ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'}`}
                        title={isTechnical ? `Alert: ${stock.technicalTrigger}` : `Alert: Buy < ₹${stock.buyAlert}`}
                      >
                         {hasAlert ? <BellRing className="w-4 h-4" /> : <Bell className="w-4 h-4" />}
                      </button>
                      <div className="text-[10px] text-slate-500 mt-1">
                        {isTechnical ? stock.technicalTrigger : stock.buyAlert ? `< ₹${stock.buyAlert}` : '-'}
                      </div>
                    </td>
                  )}

                  {/* Technical Columns Data */}
                  {isTechnical && (
                    <td className="p-4 text-right font-mono text-red-400">
                      {stock.stopLoss > 0 ? `₹${stock.stopLoss.toLocaleString()}` : '-'}
                    </td>
                  )}
                  {isTechnical && (
                    <td className="p-4 text-center">
                       <div className={`inline-block px-2 py-0.5 text-[10px] rounded border font-mono
                         ${(stock.rsi || 0) > 70 ? 'bg-red-900/20 border-red-800 text-red-400' : 
                           (stock.rsi || 0) < 30 ? 'bg-green-900/20 border-green-800 text-green-400' :
                           'bg-blue-900/20 border-blue-800 text-blue-400'}`}>
                         {stock.rsi || '-'}
                       </div>
                    </td>
                  )}
                  {isTechnical && (
                     <td className="p-4 text-center">
                        <div className="flex items-center justify-center gap-1">
                           <BarChart2 className="w-3 h-3 text-orange-500" />
                           <span className="text-slate-300 text-xs whitespace-nowrap">{stock.volumeAction || '-'}</span>
                        </div>
                     </td>
                  )}

                  {/* Fundamental Columns Data */}
                  {isFundamental && (
                    <td className="p-4 text-center">
                      <div className={`inline-block px-2 py-0.5 text-[10px] rounded border font-mono
                        ${(stock.pegRatio || 0) < 1.5 ? 'bg-emerald-900/20 border-emerald-800 text-emerald-400' : 'bg-yellow-900/20 border-yellow-800 text-yellow-400'}`}>
                        {stock.pegRatio || '-'}
                      </div>
                    </td>
                  )}
                  {isFundamental && (
                    <td className="p-4 text-center">
                       <div className="flex items-center justify-center gap-1">
                         <Scale className="w-3 h-3 text-slate-500" />
                         <span className={`text-xs ${(stock.debtToEquity || 0) < 1 ? 'text-emerald-400' : 'text-orange-400'}`}>
                            {stock.debtToEquity || '-'}
                         </span>
                       </div>
                    </td>
                  )}

                  <td className="p-4">
                     <div className="flex items-center gap-1.5 text-slate-400">
                        {isBacktest ? <History className="w-3 h-3" /> : <Clock className="w-3 h-3" />}
                        {stock.timeFrame}
                     </div>
                  </td>
                  <td className="p-4">
                    <p className="text-slate-400 leading-relaxed text-xs md:text-sm line-clamp-3 group-hover:line-clamp-none transition-all">
                      {stock.rationale}
                    </p>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      
      <div className="flex items-center justify-end gap-2 text-xs text-slate-500 px-2">
        <ShieldAlert className="w-3 h-3 text-yellow-500" />
        <span>
          {isBacktest 
             ? "Backtest results are simulated. Past performance is not indicative of future results." 
             : "Prices and Ratios verified via AI Search. Confirm with broker. Macro conditions considered."
          }
        </span>
      </div>
    </div>
  );
};
